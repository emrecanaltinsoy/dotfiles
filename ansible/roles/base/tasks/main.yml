---
# Update and install dependencies

# Load OS-specific tasks
- name: Include OS-specific tasks
  ansible.builtin.include_tasks: "{{ ansible_facts['os_family'] }}.yml"

# Install Rust (via rustup) and uv (Python package manager)

- name: Check if rustup is installed
  ansible.builtin.shell: |
    source "$HOME/.cargo/env" 2>/dev/null || true
    command -v rustup
  args:
    executable: /bin/bash
  register: rustup_check
  failed_when: false
  changed_when: false

- name: Install rustup
  ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash
  when: rustup_check.rc != 0
  changed_when: true

- name: Check if uv is installed
  ansible.builtin.shell: |
    source "$HOME/.local/bin/env" 2>/dev/null || true
    command -v uv
  args:
    executable: /bin/bash
  register: uv_check
  failed_when: false
  changed_when: false

- name: Install uv
  ansible.builtin.shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    executable: /bin/bash
  when: uv_check.rc != 0
  changed_when: true
