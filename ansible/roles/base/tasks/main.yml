---
# Update and install dependencies

# Debian/Ubuntu specific tasks
- name: Debian - Install base dependencies
  when: ansible_facts['os_family'] == "Debian"
  block:
    - name: Check if git-core PPA exists
      ansible.builtin.shell: find /etc/apt/sources.list.d -name 'git-core-ubuntu-ppa-*' | grep -q .
      register: git_ppa_check
      failed_when: false
      changed_when: false

    - name: Add git-core PPA
      ansible.builtin.shell: |
        sudo -E add-apt-repository -y ppa:git-core/ppa
      become: true
      args:
        executable: /bin/bash
      when: git_ppa_check.rc != 0

    - name: Update apt dependencies
      become: true
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes
        cache_valid_time: 3600
      failed_when: false

    - name: Install apt dependencies
      become: true
      ansible.builtin.apt:
        name:
          - bat
          - build-essential
          - curl
          - fd-find
          - fzf
          - git
          - gnupg
          - gpg
          - gpg-agent
          - jq
          - keychain
          - neofetch
          - openssh-client
          - python3
          - python3-pip
          - python3-venv
          - python3-wheel
          - python3-dev
          - ripgrep
          - socat
          - software-properties-common
          - stow
          - unzip
          - wget
          - zip
          - zoxide
          - zsh
        state: present

# RedHat/Rocky specific tasks
- name: RedHat - Install base dependencies
  when: ansible_facts['os_family'] == "RedHat"
  block:
    - name: Update dnf dependencies
      become: true
      ansible.builtin.shell: dnf upgrade -y
      args:
        executable: /bin/bash
      failed_when: false
      changed_when: false

    - name: Install EPEL repository (RHEL/Rocky/CentOS only)
      become: true
      ansible.builtin.shell: dnf install -y epel-release
      args:
        executable: /bin/bash
      failed_when: false
      changed_when: false
      when: ansible_facts['distribution'] != "Fedora"

    - name: Check if Development Tools group is installed
      ansible.builtin.shell: dnf group list --installed | grep -q "Development Tools"
      args:
        executable: /bin/bash
      register: devtools_check
      failed_when: false
      changed_when: false

    - name: Install Development Tools group
      become: true
      ansible.builtin.shell: dnf group install -y "Development Tools" || dnf install -y @development-tools || true
      args:
        executable: /bin/bash
      failed_when: false
      when: devtools_check.rc != 0

    - name: Install dnf dependencies
      become: true
      ansible.builtin.shell: |
        # Try dnf5 syntax first, fall back to dnf4
        dnf install -y --skip-unavailable \
          bat fd-find fzf gawk git git-delta gnupg2 jq keychain fastfetch openssh-clients \
          python3 python3-pip python3-devel ripgrep socat unzip wget zip zsh stow 2>/dev/null || \
        dnf install -y \
          bat fd-find fzf gawk git git-delta gnupg2 jq keychain neofetch openssh-clients \
          python3 python3-pip python3-devel ripgrep socat unzip wget zip zsh stow
      args:
        executable: /bin/bash
      register: dnf_install_result
      changed_when: "'Nothing to do' not in dnf_install_result.stdout and 'already installed' not in dnf_install_result.stderr"

# Install Rust (via rustup) and uv (Python package manager)

- name: Check if rustup is installed
  ansible.builtin.shell: |
    source "$HOME/.cargo/env" 2>/dev/null || true
    command -v rustup
  args:
    executable: /bin/bash
  register: rustup_check
  failed_when: false
  changed_when: false

- name: Install rustup
  ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    executable: /bin/bash
  when: rustup_check.rc != 0
  changed_when: true

- name: Check if uv is installed
  ansible.builtin.shell: |
    source "$HOME/.local/bin/env" 2>/dev/null || true
    command -v uv
  args:
    executable: /bin/bash
  register: uv_check
  failed_when: false
  changed_when: false

- name: Install uv
  ansible.builtin.shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    executable: /bin/bash
  when: uv_check.rc != 0
  changed_when: true
