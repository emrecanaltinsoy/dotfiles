---
# RedHat/Rocky/Fedora specific tasks

- name: Update dnf dependencies
  become: true
  ansible.builtin.shell: dnf upgrade -y
  args:
    executable: /bin/bash
  failed_when: false
  changed_when: false

- name: Install EPEL repository (RHEL/Rocky/CentOS only)
  become: true
  ansible.builtin.shell: dnf install -y epel-release
  args:
    executable: /bin/bash
  failed_when: false
  changed_when: false
  when: ansible_facts['distribution'] != "Fedora"

- name: Check if Development Tools group is installed
  ansible.builtin.shell: dnf group list --installed | grep -q "Development Tools"
  args:
    executable: /bin/bash
  register: devtools_check
  failed_when: false
  changed_when: false

- name: Install Development Tools group
  become: true
  ansible.builtin.shell: dnf group install -y "Development Tools" || dnf install -y @development-tools || true
  args:
    executable: /bin/bash
  failed_when: false
  when: devtools_check.rc != 0

- name: Install dnf dependencies
  become: true
  ansible.builtin.shell: |
    # Try dnf5 syntax first, fall back to dnf4
    dnf install -y --skip-unavailable \
      bat fd-find fzf gawk git git-delta gnupg2 jq keychain fastfetch openssh-clients \
      python3 python3-pip python3-devel ripgrep socat unzip wget zip zsh stow 2>/dev/null || \
    dnf install -y \
      bat fd-find fzf gawk git git-delta gnupg2 jq keychain neofetch openssh-clients \
      python3 python3-pip python3-devel ripgrep socat unzip wget zip zsh stow
  args:
    executable: /bin/bash
  register: dnf_install_result
  changed_when: "'Nothing to do' not in dnf_install_result.stdout and 'already installed' not in dnf_install_result.stderr"
