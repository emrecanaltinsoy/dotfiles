---
# Install cargo packages

- name: Define cargo packages to install
  ansible.builtin.set_fact:
    cargo_packages:
      - name: alacritty
        bin: alacritty
        skip_wsl: true
      - name: bat
        bin: bat
      - name: exa
        bin: exa
      - name: fd-find
        bin: fd
      - name: git-delta
        bin: delta
      - name: procs
        bin: procs
      - name: rm-improved
        bin: rip
      - name: ripgrep
        bin: rg
      - name: tokei
        bin: tokei
      - name: topgrade
        bin: topgrade
      - name: xcp
        bin: xcp
      - name: xh
        bin: xh
      # - name: yazi-fm
      #   bin: yazi
      # - name: zellij
      #   bin: zellij
      - name: zoxide
        bin: zoxide

- name: Check if cargo is available
  ansible.builtin.shell: |
    source "$HOME/.cargo/env" 2>/dev/null || true
    command -v cargo
  args:
    executable: /bin/bash
  register: cargo_check
  failed_when: false
  changed_when: false

- name: Install cargo packages
  when: cargo_check.rc == 0
  block:
    - name: Check which cargo packages are already installed
      ansible.builtin.shell: |
        source "$HOME/.cargo/env" 2>/dev/null || true
        command -v {{ item.bin }}
      args:
        executable: /bin/bash
      loop: "{{ cargo_packages }}"
      loop_control:
        label: "{{ item.name }}"
      register: package_checks
      failed_when: false
      changed_when: false
      when: not (item.skip_wsl | default(false) and IS_WSL)

    - name: Build list of missing cargo packages
      ansible.builtin.set_fact:
        missing_cargo_packages: "{{ package_checks.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | map(attribute='item.name') | list }}"

    - name: Display cargo package status
      ansible.builtin.debug:
        msg: "Installed: {{ package_checks.results | selectattr('rc', 'defined') | selectattr('rc', 'eq', 0) | map(attribute='item.name') | list | join(', ') | default('none', true) }}"

    - name: Display missing cargo packages
      ansible.builtin.debug:
        msg: "Will be installed: {{ missing_cargo_packages | join(', ') }}"
      when: missing_cargo_packages | length > 0

    - name: Install all missing cargo packages
      ansible.builtin.shell: |
        source "$HOME/.cargo/env" 2>/dev/null || true
        cargo install {{ missing_cargo_packages | join(' ') }} --locked
      args:
        executable: /bin/bash
      when: missing_cargo_packages | length > 0
      register: cargo_install_result

    - name: Display installation result
      ansible.builtin.debug:
        msg: "Successfully installed: {{ missing_cargo_packages | join(', ') }}"
      when:
        - missing_cargo_packages | length > 0
        - cargo_install_result is succeeded
