---
# Install additional packages (non-cargo)

# AWS CLI
- name: Check if AWS CLI is installed
  ansible.builtin.shell: command -v aws
  register: aws_check
  failed_when: false
  changed_when: false

- name: Install AWS CLI
  ansible.builtin.shell: |
    cd "$HOME"
    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    unzip -o awscliv2.zip
    sudo ./aws/install
    rm -rf awscliv2.zip aws
  args:
    executable: /bin/bash
  when: aws_check.rc != 0
  changed_when: true
  register: aws_result
  retries: 3
  delay: 5
  until: aws_result.rc == 0

# Lazygit
- name: Check if lazygit is installed
  ansible.builtin.shell: |
    export PATH="$HOME/.bin:$PATH"
    command -v lazygit
  args:
    executable: /bin/bash
  register: lazygit_check
  failed_when: false
  changed_when: false

- name: Install lazygit
  ansible.builtin.shell: |
    cd "$HOME"
    wget https://github.com/jesseduffield/lazygit/releases/download/v{{ lazygit_version }}/lazygit_{{ lazygit_version }}_Linux_x86_64.tar.gz -O lazygit.tar.gz
    tar xzf lazygit.tar.gz
    mkdir -p "$HOME/.bin"
    mv lazygit "$HOME/.bin/lazygit"
    rm -f lazygit.tar.gz LICENSE README.md
  args:
    executable: /bin/bash
  when: lazygit_check.rc != 0
  changed_when: true
  register: lazygit_result
  retries: 3
  delay: 5
  until: lazygit_result.rc == 0

# Neovim
- name: Check if neovim is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/nvim-linux-x86_64"
  register: nvim_check

- name: Install neovim
  ansible.builtin.shell: |
    cd "$HOME"
    wget https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.tar.gz -O nvim-linux-x86_64.tar.gz
    tar xzf nvim-linux-x86_64.tar.gz
    rm nvim-linux-x86_64.tar.gz
  args:
    executable: /bin/bash
  when: not nvim_check.stat.exists
  changed_when: true
  register: nvim_result
  retries: 3
  delay: 5
  until: nvim_result.rc == 0

# NVM
- name: Check if nvm is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.nvm/nvm.sh"
  register: nvm_check

- name: Install nvm
  ansible.builtin.shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v{{ nvm_version }}/install.sh | bash
  args:
    executable: /bin/bash
  when: not nvm_check.stat.exists
  changed_when: true
  register: nvm_result
  retries: 3
  delay: 5
  until: nvm_result.rc == 0

# OpenCode
- name: Check if opencode is installed
  ansible.builtin.shell: |
    export PATH="$HOME/.opencode/bin:$PATH"
    command -v opencode
  args:
    executable: /bin/bash
  register: opencode_check
  failed_when: false
  changed_when: false

- name: Install opencode
  ansible.builtin.shell: curl -fsSL https://opencode.ai/install | bash
  args:
    executable: /bin/bash
  when: opencode_check.rc != 0
  changed_when: true
  register: opencode_result
  retries: 3
  delay: 5
  until: opencode_result.rc == 0

# SOPS
- name: Check if sops is installed
  ansible.builtin.shell: |
    export PATH="$HOME/.bin:$PATH"
    command -v sops
  args:
    executable: /bin/bash
  register: sops_check
  failed_when: false
  changed_when: false

- name: Install sops
  ansible.builtin.shell: |
    mkdir -p "$HOME/.bin"
    wget https://github.com/getsops/sops/releases/download/v{{ sops_version }}/sops-v{{ sops_version }}.linux.amd64 -O "$HOME/.bin/sops"
    chmod +x "$HOME/.bin/sops"
  args:
    executable: /bin/bash
  when: sops_check.rc != 0
  changed_when: true
  register: sops_result
  retries: 3
  delay: 5
  until: sops_result.rc == 0

# Starship
- name: Check if starship is installed
  ansible.builtin.shell: |
    export PATH="$HOME/.bin:$PATH"
    command -v starship
  args:
    executable: /bin/bash
  register: starship_check
  failed_when: false
  changed_when: false

- name: Install starship
  ansible.builtin.shell: |
    mkdir -p "$HOME/.bin"
    curl -sS https://starship.rs/install.sh | sh -s -- -y -b "$HOME/.bin"
  args:
    executable: /bin/bash
  when: starship_check.rc != 0
  changed_when: true
  register: starship_result
  retries: 3
  delay: 5
  until: starship_result.rc == 0

# Terraform - Debian/Ubuntu
- name: Check if HashiCorp GPG key exists
  ansible.builtin.stat:
    path: /usr/share/keyrings/hashicorp-archive-keyring.gpg
  register: hashicorp_gpg
  when: ansible_facts['os_family'] == "Debian"

- name: Check if terraform is installed
  ansible.builtin.shell: command -v terraform
  register: terraform_check
  failed_when: false
  changed_when: false

- name: Add HashiCorp GPG key (Debian)
  ansible.builtin.shell: wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  args:
    executable: /bin/bash
  when:
    - ansible_facts['os_family'] == "Debian"
    - terraform_check.rc != 0
    - not hashicorp_gpg.stat.exists
  changed_when: true
  register: hashicorp_gpg_result
  retries: 3
  delay: 5
  until: hashicorp_gpg_result.rc == 0

- name: Add HashiCorp apt repository (Debian)
  ansible.builtin.shell: |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
  args:
    executable: /bin/bash
  when:
    - ansible_facts['os_family'] == "Debian"
    - terraform_check.rc != 0
  changed_when: true

- name: Install terraform (Debian)
  become: true
  ansible.builtin.apt:
    name: terraform
    state: present
    update_cache: yes
  when:
    - ansible_facts['os_family'] == "Debian"
    - terraform_check.rc != 0

# Terraform - RedHat/Rocky
- name: Add HashiCorp repository (RedHat)
  become: true
  ansible.builtin.shell: |
    dnf config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
  args:
    executable: /bin/bash
    creates: /etc/yum.repos.d/hashicorp.repo
  when:
    - ansible_facts['os_family'] == "RedHat"
    - terraform_check.rc != 0

- name: Install terraform (RedHat)
  become: true
  ansible.builtin.dnf:
    name: terraform
    state: present
  when:
    - ansible_facts['os_family'] == "RedHat"
    - terraform_check.rc != 0

# Tmux and Oh-My-Tmux
- name: Check if tmux is installed
  ansible.builtin.shell: command -v tmux
  register: tmux_check
  failed_when: false
  changed_when: false

- name: Install tmux (Debian)
  become: true
  ansible.builtin.apt:
    name: tmux
    state: present
  when:
    - ansible_facts['os_family'] == "Debian"
    - tmux_check.rc != 0

- name: Install tmux (RedHat)
  become: true
  ansible.builtin.dnf:
    name: tmux
    state: present
  when:
    - ansible_facts['os_family'] == "RedHat"
    - tmux_check.rc != 0

- name: Check if oh-my-tmux is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/oh-my-tmux"
  register: omt_dir

- name: Install oh-my-tmux
  ansible.builtin.shell: |
    cd "$HOME"
    git clone --single-branch https://github.com/gpakosz/.tmux.git oh-my-tmux
    mkdir -p "$HOME/.config/tmux"
    ln -s -f "$HOME/oh-my-tmux/.tmux.conf" "$HOME/.config/tmux/tmux.conf"
  args:
    executable: /bin/bash
  when: not omt_dir.stat.exists
  changed_when: true
  register: omt_result
  retries: 3
  delay: 5
  until: omt_result.rc == 0

- name: Check if tmuxifier is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.tmuxifier"
  register: tmuxifier_dir

- name: Install tmuxifier
  ansible.builtin.git:
    repo: https://github.com/jimeh/tmuxifier.git
    dest: "{{ ansible_facts['user_dir'] }}/.tmuxifier"
  when: not tmuxifier_dir.stat.exists
