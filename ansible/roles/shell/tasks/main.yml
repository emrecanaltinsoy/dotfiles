---
# Install ZSH and Oh-My-Zsh with plugins

- name: Check if oh-my-zsh is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh"
  register: omz_dir

- name: Install Oh-My-Zsh
  ansible.builtin.shell: |
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  args:
    executable: /bin/bash
  when: not omz_dir.stat.exists

- name: Check if zsh-syntax-highlighting plugin is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
  register: zsh_syntax_highlighting_dir

- name: Install zsh-syntax-highlighting plugin
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting
    dest: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
  when: not zsh_syntax_highlighting_dir.stat.exists
  register: zsh_syntax_result
  retries: 3
  delay: 5
  until: zsh_syntax_result is success

- name: Check if zsh-autosuggestions plugin is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
  register: zsh_autosuggestions_dir

- name: Install zsh-autosuggestions plugin
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
  when: not zsh_autosuggestions_dir.stat.exists
  register: zsh_autosuggestions_result
  retries: 3
  delay: 5
  until: zsh_autosuggestions_result is success

- name: Check if k plugin is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/k"
  register: k_dir

- name: Install k plugin
  ansible.builtin.git:
    repo: https://github.com/supercrabtree/k
    dest: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/k"
  when: not k_dir.stat.exists
  register: k_result
  retries: 3
  delay: 5
  until: k_result is success

- name: Check if zsh-fzf-history-search plugin is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/zsh-fzf-history-search"
  register: zsh_fzf_history_search_dir

- name: Install zsh-fzf-history-search plugin
  ansible.builtin.git:
    repo: https://github.com/joshskidmore/zsh-fzf-history-search
    dest: "{{ ansible_facts['user_dir'] }}/.oh-my-zsh/custom/plugins/zsh-fzf-history-search"
  when: not zsh_fzf_history_search_dir.stat.exists
  register: zsh_fzf_result
  retries: 3
  delay: 5
  until: zsh_fzf_result is success

- name: Get current user shell
  ansible.builtin.shell: "getent passwd {{ ansible_facts['user_id'] }} | cut -d: -f7"
  register: current_shell
  changed_when: false

- name: Get zsh path
  ansible.builtin.shell: which zsh
  register: zsh_path
  changed_when: false

- name: Set zsh as default shell
  become: true
  ansible.builtin.user:
    name: "{{ ansible_facts['user_id'] }}"
    shell: "{{ zsh_path.stdout }}"
  when: current_shell.stdout != zsh_path.stdout

- name: Track shell change notification
  ansible.builtin.set_fact:
    shell_changed_message: "Default shell changed to zsh. Please logout and login again, then restart the deployment for changes to take effect."
  when: current_shell.stdout != zsh_path.stdout

- name: Check if .zshrc exists in home directory
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.zshrc"
  register: zshrc_home

- name: Check if .zshrc exists in .config/zsh
  ansible.builtin.stat:
    path: "{{ ansible_facts['user_dir'] }}/.config/zsh/.zshrc"
  register: zshrc_config

- name: Initialize zsh shell from home directory
  ansible.builtin.shell: zsh -c 'source ~/.zshrc'
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false
  when: zshrc_home.stat.exists

- name: Initialize zsh shell from .config/zsh
  ansible.builtin.shell: zsh -c 'source ~/.config/zsh/.zshrc'
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false
  when: not zshrc_home.stat.exists and zshrc_config.stat.exists
