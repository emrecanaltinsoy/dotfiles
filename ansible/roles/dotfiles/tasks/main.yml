---
# Stow dotfiles to home directory

- name: Stow dotfiles
  block:
    - name: Define dotfile directories to stow
      ansible.builtin.set_fact:
        dotfile_dirs:
          - alacritty
          - bash
          - git
          - lazygit
          - neofetch
          - nvim
          - opencode
          - starship
          - tmux
          - topgrade
          - zellij
          - zsh
        dotfiles_repo_url: "https://github.com/emrecanaltinsoy/dotfiles.git"
        dotfiles_repo_dest: "{{ ansible_facts['user_dir'] }}/dotfiles"

    - name: Check if dotfiles repo exists locally (playbook location)
      ansible.builtin.stat:
        path: "{{ playbook_dir | dirname }}"
      register: local_repo_check

    - name: Check if dotfiles repo exists in home directory
      ansible.builtin.stat:
        path: "{{ dotfiles_repo_dest }}"
      register: home_repo_check

    - name: Set dotfiles repository path
      ansible.builtin.set_fact:
        dotfiles_repo: "{{ playbook_dir | dirname if local_repo_check.stat.exists else dotfiles_repo_dest }}"

    - name: Clone dotfiles repository if not present
      ansible.builtin.git:
        repo: "{{ dotfiles_repo_url }}"
        dest: "{{ dotfiles_repo_dest }}"
        version: main
      when:
        - not local_repo_check.stat.exists
        - not home_repo_check.stat.exists
      register: dotfiles_clone_result
      retries: 3
      delay: 5
      until: dotfiles_clone_result is success

    - name: Update dotfiles repository path after clone
      ansible.builtin.set_fact:
        dotfiles_repo: "{{ dotfiles_repo_dest }}"
      when:
        - not local_repo_check.stat.exists

    - name: Check if stow is installed
      ansible.builtin.shell: command -v stow
      register: stow_check
      failed_when: false
      changed_when: false

    - name: Install stow if not present (Debian)
      become: true
      ansible.builtin.apt:
        name: stow
        state: present
      when:
        - stow_check.rc != 0
        - ansible_facts['os_family'] == "Debian"

    - name: Install stow if not present (RedHat)
      become: true
      ansible.builtin.shell: dnf install -y stow
      args:
        executable: /bin/bash
      when:
        - stow_check.rc != 0
        - ansible_facts['os_family'] == "RedHat"

    - name: Check stow status for dotfile directories
      ansible.builtin.shell: |
        cd "{{ dotfiles_repo }}"
        stow --no --verbose {{ item }} -t "$HOME" 2>&1 || true
      args:
        executable: /bin/bash
      loop: "{{ dotfile_dirs }}"
      loop_control:
        label: "{{ item }}"
      register: stow_check_result
      changed_when: false

    - name: Stow dotfile directories (adopt existing files)
      ansible.builtin.shell: |
        cd "{{ dotfiles_repo }}"
        stow --adopt --override ".*" {{ item.item }} -t "$HOME" 2>&1
      args:
        executable: /bin/bash
      loop: "{{ stow_check_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item | default('skipped') }}"
      register: stow_result
      changed_when: "'LINK:' in item.stdout or 'UNLINK:' in item.stdout"
      failed_when: false
      when:
        - stow_check_result.results is defined
        - "'LINK:' in item.stdout or 'UNLINK:' in item.stdout or 'cannot stow' in item.stdout"

    - name: Restore adopted files to repo version
      ansible.builtin.shell: |
        cd "{{ dotfiles_repo }}"
        git checkout -- .
      args:
        executable: /bin/bash
      changed_when: false
      when: stow_check_result.results is defined

    - name: Report stow results
      ansible.builtin.debug:
        msg: "Stowed {{ item.item.item }} - {{ 'success' if item.rc | default(0) == 0 else 'skipped' }}"
        verbosity: 1
      loop: "{{ stow_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.item | default('skipped') }}"
      when:
        - stow_result.results is defined
        - item.rc is defined
