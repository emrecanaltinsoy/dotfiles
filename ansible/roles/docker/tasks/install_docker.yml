---
# Install Docker (Debian) or Podman (RedHat)

# Debian/Ubuntu - use get.docker.com convenience script
- name: Debian - Install Docker
  when: ansible_facts['os_family'] == "Debian"
  block:
    - name: Download and install Docker
      become: true
      ansible.builtin.shell: |
        curl -fsSL https://get.docker.com -o - | bash
      args:
        executable: /bin/bash
        creates: /usr/bin/docker

    - name: Add docker group
      become: true
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add user to docker group
      become: true
      ansible.builtin.user:
        name: "{{ ansible_facts['user_id'] }}"
        groups: docker
        append: yes

# RedHat/Rocky - use Podman (native container runtime)
- name: RedHat - Install Podman
  when: ansible_facts['os_family'] == "RedHat"
  block:
    - name: Check if Podman is installed
      ansible.builtin.shell: command -v podman
      register: podman_check
      failed_when: false
      changed_when: false

    - name: Install Podman packages
      become: true
      ansible.builtin.shell: dnf install -y podman podman-docker buildah skopeo
      args:
        executable: /bin/bash
      when: podman_check.rc != 0
